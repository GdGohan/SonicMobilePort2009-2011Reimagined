<!DOCTYPE html>
<html lang="pt-BR">
<head>
<link rel="icon" href="Icon.png" type="image/png">
<meta name="viewport"
      content="width=480, height=320, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
<title>EmulatorJS UI</title>

<style>
html,body{
    margin:0;
    padding:0;
    background:#000;
    overflow:hidden;
    touch-action:none;
}

#root{
    position:fixed;
    width:480px;
    height:320px;
    top:50%;
    left:50%;
    transform:translate(-50%,-50%);
    z-index:1;
}

/* ===== EMULADOR ===== */
#game{
    position:absolute;
    width:480px;
    height:320px;
    z-index:1;
}

/* Moldura transparente */
#frame{
    position:absolute;
    width:480px;
    height:320px;
    background:url("C2_Back.png") no-repeat;
    background-size:cover;
    display:none;
    pointer-events:none;
    z-index:1;
}

#logo{
    transition: opacity 1s ease;
    position:absolute;
    width:480px;
    height:320px;
    display:block;
    /* iPhone_Sonic1_Title_480x320 */
    background:url("logos/0.png") no-repeat;
    background-size:cover;
    pointer-events:none;
    z-index:9;
    pointer-events:auto;
}

#fadeBlack {
    position: fixed;
    inset: 0;
    background: #000;
    opacity: 0;
    pointer-events: none;
    transition: opacity 1s ease;
}

/* ===== START ===== */
#btnStart{
    position:absolute;
    opacity:0.5;
    top:18px;
    left:84%;
    transform:translateX(-50%);
    width:70px;
    height:15px;
    z-index:6;
}

/* ===== BOTÃO SPACE ===== */
#btnSpace{
    position:absolute;
    opacity:0.5;
    bottom:5px;
    right:30px;
    width:88px;
    height:88px;
    z-index:6;
}

/* ===== MENU ===== */
#menu{
    position:absolute;
    top:50%;
    left:52%;
    transform:translate(-50%,-50%);
    display:none;
    z-index:7;
}
.menuBtn{
    display:block;
    margin:10px auto;
}

/* ===== BOTÃO ESPECIAL ===== */
#specialBtn{
    position:absolute;
    top:50px;
    right:40px;
    width:64px;
    height:64px;
    z-index:6;
}

/* ===== OVERLAY ===== */
#overlay {
    position:absolute;
    width:100%;
    height:100%;
    display:none;
    z-index:8;
    pointer-events:auto;
}
#overlayImg {
    position:absolute;
    width:100%;
    height:100%;
    background:url("Sonic-iPhone_PromoFrame.png") no-repeat;
    background-size:cover;
    z-index:9; /* sobre a imagem */
    pointer-events:none; /* impede que bloqueie clique nos vídeos */
}
.video {
    position:absolute;
    width:114px;
    height:114px;
    z-index:8; /* abaixo da imagem, mas acima do resto */
    pointer-events:auto; /* garante clique nos vídeos */
}
#video1{ top:110px; left:18px; }
#video2{ top:110px; right:182px; }

/* ===== D-PAD ÚNICO ===== */
#dpad{
    position:absolute;
    opacity:0.5;
    bottom:5px;
    left:30px;
    width:115px;
    height:115px;
    z-index:6;
}

.menuBtnContainer {
    position: relative;
    display: inline-block; /* mantém os botões lado a lado */
}

.menuBtnText {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%); /* centraliza o texto */
    color: white; /* ajusta conforme a imagem */
    font-weight: bold;
    pointer-events: none; /* evita que o texto interfira no clique */
}

#bg{
    position:fixed;
    inset:0;
    background:url("megadrive-background.jpg") no-repeat center;
    background-size:cover;
    z-index:0;
}

#tiles{
    position:fixed;
    top:50%;
    left:50%;
    width:480px;
    height:320px;
    transform:translate(-50%,-50%);
    pointer-events:none;
    display:none;
    z-index:0;
}

.tileL, .tileR{
    position:absolute;
    top:0;
    height:320px;
    background:url("tile.png") repeat-x;
}

.tileR{
    background-position-x: -10px;
}

@font-face {
    font-family: 'PressStart2P';
    src: url('roms/PressStart2P-Regular.ttf') format('truetype');
}

#romMenu {
    position:absolute;
    top:50%;
    left:50%;
    transform:translate(-50%, -50%);
    z-index:10;
    background:rgba(0,0,0,0.7);
    padding:20px;
    border:2px solid #FFC;
    font-family: 'PressStart2P', monospace;
    color:#FFC;
}

#romMenu h2 {
    text-align:center;
    margin:0 0 15px 0;
    color:#FFC;
    font-size:12px;
}

#romList {
    list-style:none;
    padding:0;
    margin:0;
    text-align:center;
}

#romList li {
    padding:6px 0;
    cursor:pointer;
}

#romList li.selected {
    background:#FFC;
    color:#000;
}

</style>
</head>

<body>

<div id="bg"></div>
<div id="root">
    <div id="romMenu">
        <h2>SELECT THE ROM</h2>
        <ul id="romList"></ul>
    </div>
    <div id="frame"></div>
    <div id="game"></div>

    <div id="sp">
        <img id="specialBtn" src="Menu_Button_Moon_normal.png">
    </div>

    <div id="menu">
        <div class="menuBtnContainer">
            <img id="btnResume" class="menuBtn" src="Menu_Button_normal.png">
            <span class="menuBtnText">Resume</span>
        </div>
        <div class="menuBtnContainer">
            <img id="btnFrame" class="menuBtn" src="Menu_Button_normal.png">
            <span class="menuBtnText">Custom UI</span>
        </div>
    </div>

    <div id="overlay">
        <div id="overlayImg"></div>
        <iframe id="video1" class="video" src="https://www.youtube.com/embed/ESEf089-6Xs?enablejsapi=1"></iframe>
        <iframe id="video2" class="video" src="https://www.youtube.com/embed/RW3eBWQ1IyQ?enablejsapi=1"></iframe>
    </div>
    <img id="btnStart" src="C2_Start_NotPressed.png">
    <img id="btnSpace" src="A_Button_NotPressed.png">
    <img id="dpad" src="C2_DPad_NotPressed.png">
    <div id="logo"></div>
    <div id="fadeBlack"></div>
</div>
<div id="tiles">
    <div class="tileL"></div>
    <div class="tileR"></div>
</div>

<!-- EmulatorJS -->
<script>

sp.style.display="none";

let useStart;
let playing;
let closeBootMenu;
let timeout;
let timeout2;

const romMenuEl = document.getElementById("romMenu");
const romListEl = document.getElementById("romList");
let roms = [];
let selectedIndex = 0;

// Funções que já existem no seu código
function updateHighlight() {
    Array.from(romListEl.children).forEach((li, i) => {
        li.classList.toggle("selected", i === selectedIndex);
    });
}

function showLogo() {
    logo.style.display = "block";
    logo.style.opacity = "1";
    fadeBlack.style.opacity = "0";
}

function resetEmulator() {
    if (window.EJS_emulator) {
        try {
            EJS_emulator.pause();
            EJS_emulator = null;
        } catch(e){}
    }
    const game = document.getElementById("game");
    game.innerHTML = "";
    document.querySelectorAll('script[src*="loader.js"]').forEach(s => s.remove());
}

function bootMenu() {
    romMenuEl.style.display = "";
    setTimeout(() => { closeBootMenu = true; }, 200);
}

document.addEventListener("touchstart", e => {
if (!closeBootMenu) return;
setTimeout(() => {
if (romMenuEl.style.display !== "none" &&
    !romMenuEl.contains(e.target)) {
    romMenuEl.style.display = "none";
    closeBootMenu = false;
}
}, 100);
});

function startEmulatorWithRom(romFile) {
    showLogo();
    resetEmulator();
    clearTimeout(timeout);
    clearTimeout(timeout2);
    useStart = false;
    playing = false;
    
    // Esconde o menu
    romMenuEl.style.display = "none";

    // Define as variáveis necessárias do EJS
    window.EJS_player = "#game";
    window.EJS_core = "segaMD";
    window.EJS_gameUrl = "roms/" + romFile;
    window.EJS_pathtodata = "data/";
    window.EJS_startOnLoaded = true;

    // Cria dinamicamente o loader.js
    const script = document.createElement("script");
    script.src = "data/loader.js";
    script.onload = () => {
        // Espera o emulador estar pronto
        const waitEJS = setInterval(() => {
            if (window.EJS_emulator) {
                hideEJSMenu(true);
                hideVirtualGamepad(false);
                clearInterval(waitEJS);
            }
        }, 100);
    };
    document.body.appendChild(script);
}

// Carregar lista de ROMs via JSON e adicionar clique
fetch('roms/roms.json')
  .then(res => res.json())
  .then(data => {
      roms = data;
      roms.forEach((rom, i) => {
          const li = document.createElement("li");
          li.textContent = rom;
          if (i === selectedIndex) li.classList.add("selected");

          li.addEventListener("click", () => {
              if (selectedIndex !== i) {
              selectedIndex = i;
              updateHighlight();
              document.getElementById("logo").style.background = `url('logos/${i}.png') no-repeat`;
              } else startEmulatorWithRom(rom);
          });

          romListEl.appendChild(li);
      });
  });

function hideVirtualGamepad(temp = true) {
    const selectors = [
        ".ejs_virtualGamepad_left",
        ".ejs_virtualGamepad_right",
        ".ejs_virtualGamepad_bottom",
    ];

    selectors.forEach(sel => {
        document.querySelectorAll(sel).forEach(el => {
            el.style.display = "none";
            el.style.pointerEvents = "none";
        });
    });

    if (temp) {
        timeout = setTimeout(showVirtualGamepad, 14000);
    }
}

function showVirtualGamepad() {
    const selectors = [
        ".ejs_virtualGamepad_left",
        ".ejs_virtualGamepad_right",
        ".ejs_virtualGamepad_bottom",
    ];

    selectors.forEach(sel => {
        document.querySelectorAll(sel).forEach(el => {
            el.style.display = "";
            el.style.pointerEvents = "";
        });
    });
}

function hideEJSMenu(temp = true) {
    const menus = document.querySelectorAll(".ejs_menu_bar");

    menus.forEach(el => {
        // Torna invisível e bloqueia qualquer interação (clique/hover)
        el.style.visibility = "hidden";
        el.style.pointerEvents = "none";
        
        // Garante que o menu de ajustes (settings) também não seja clicável se estiver aberto
        el.style.opacity = "0";
    });

    if (temp) {
        timeout2 = setTimeout(showEJSMenu, 14000);
    }
}

function showEJSMenu() {
    const menus = document.querySelectorAll(".ejs_menu_bar");

    menus.forEach(el => {
        // Restaura a visibilidade e a capacidade de clique
        el.style.visibility = "visible";
        el.style.pointerEvents = "auto";
        el.style.opacity = "1";
    });
}

function isEJSMenuVisible() {
    const menu = document.querySelector(".ejs_menu_bar");
    if (!menu) return false;
    return !menu.classList.contains("ejs_menu_bar_hidden");
}

function lockScale(){
    const sw = window.innerWidth;
    const sh = window.innerHeight;

    const scale = Math.min(sw / 480, sh / 320);

    const root = document.getElementById("root");
    const tiles = document.getElementById("tiles");

    root.style.transform = `translate(-50%, -50%) scale(${scale})`;
    tiles.style.transform = `translate(-50%, -50%) scale(${scale})`;

    // ajustar tiles lateral
    const extraW = (sw / scale - 480) / 2;
    document.querySelector(".tileL").style.width = extraW + "px";
    document.querySelector(".tileL").style.right = "480px";
    document.querySelector(".tileR").style.width = extraW + "px";
    document.querySelector(".tileR").style.left = "480px";

    // Ajustar botão Start no landscape
    const btnStart = document.getElementById("btnStart");
    btnStart.style.left = `${480 * 0.84}px`; // 84%
    btnStart.style.top = "18px";
    btnStart.style.transform = "translateX(-50%)";
}

window.addEventListener("resize", lockScale);
window.addEventListener("orientationchange", lockScale);
lockScale();

const interval = setInterval(() => {
  if (window.EJS_emulator && !useStart) {
      const AL = EJS_emulator?.Module?.AL;
      if (!AL || !AL.currentCtx) return;
      AL.currentCtx.sources.forEach(src => {
         if (src.playbackState === src.PLAYING_STATE) {
             playing = true;
             logo.style.opacity = "0";
             fadeBlack.style.opacity = "1";
             setTimeout(() => { logo.style.display = "none"; }, 1000);
         }
      });
      if (playing) {
          useStart = true;
          //clearInterval(interval);
      }
  }
}, 100);

function focusEmulator(){
    const el = document.querySelector(EJS_player);
    if (el) el.focus();
}

/* ===== TECLAS ===== */
let pressed = [];

const KEYMAP = {
    ArrowUp: 4,
    ArrowDown: 5,
    ArrowLeft: 6,
    ArrowRight: 7,
    B: 0,
    Enter: 3,
    Z: 1,
    C: 8
};

function sendKeyToEmulator(index, pressed) {
    if (!window.EJS_emulator || !EJS_emulator.gameManager) return;
    EJS_emulator.gameManager.simulateInput(0, index, pressed ? 1 : 0);
}

function press(k){
    if (pressed.includes(k)) return;
    pressed.push(k);
    sendKeyToEmulator(KEYMAP[k], true);
}

function releaseAll(){
    pressed.forEach(k => {
        sendKeyToEmulator(KEYMAP[k], false);
    });
    pressed.length = 0;
}

/* ===== START / MENU ===== */
let menuOpen=false;
btnStart.ontouchstart=()=> { if (!menuOpen && useStart) { /*press("Enter");*/ openMenu(); } }
function openMenu(){ menu.style.display="block"; sp.style.display="block"; menuOpen=true; btnStart.src="C2_Start_Pressed.png";
setTimeout(() => {
    btnStart.src="C2_Start_NotPressed.png";
    if (window.EJS_emulator) {
        EJS_emulator.pause();
    }
}, 100);
}
function closeMenu(){ menu.style.display="none"; sp.style.display="none"; menuOpen=false; }

btnResume.ontouchstart=()=> { /*press("Enter");*/ btnResume.src="Menu_Button_highlighted.png"; 
setTimeout(() => {
    btnResume.src="Menu_Button_normal.png";
    closeMenu();
    if (window.EJS_emulator) {
        EJS_emulator.play();
    }
}, 100);
}

btnResume.ontouchend=()=> { releaseAll(); }
btnStart.ontouchend = () => { releaseAll(); }

function addEmuTouchListener() {
    const emuEl = document.querySelector("#game");
    if (!emuEl) return;

    const activeTouches = {}; // map: touchId -> key

    emuEl.addEventListener('touchstart', e => {
        const rect = emuEl.getBoundingClientRect();
        const rect2 = btnSpace.getBoundingClientRect();

        for (let t of e.changedTouches) {
            const x = t.clientX;
            const y = t.clientY;
            let key = null;

            const zoneHeight = rect2.height;
            const topZone = rect2.top - zoneHeight;
            const midZone = rect2.top - zoneHeight / 2;
            if (x >= rect2.left && x <= rect2.right &&
                y >= topZone && y < rect2.top) {
        
                if (y < midZone) {
                    key = "B";
                } else {
                    key = "C";
                }
            } else {
                const rect = emuEl.getBoundingClientRect();
                const rx = x - rect.left;
                const ry = y - rect.top;
                
                if (rx >= 0 &&
                    rx <= rect.width * 0.2 &&
                    ry >= 0 &&
                    ry <= rect.height * 0.2) {
                    bootMenu();
                    return;
                }
        
                if (!isEJSMenuVisible() && rx >= rect.width * 0.4 &&
                    rx <= rect.width * 0.75 &&
                    ry >= rect.height * 0.6) {
                    key = "Enter";
                }
            }
        
            if (key) {
                press(key);
                activeTouches[t.identifier] = key;
            }
        }
    });

    emuEl.addEventListener('touchend', e => {
        for (let t of e.changedTouches) {
            const key = activeTouches[t.identifier];
            if (key) {
                sendKeyToEmulator(KEYMAP[key], false);
                pressed = pressed.filter(k => k !== key);
                delete activeTouches[t.identifier];
            }
        }
    });

    emuEl.addEventListener('touchcancel', e => {
        for (let t of e.changedTouches) {
            const key = activeTouches[t.identifier];
            if (key) {
                sendKeyToEmulator(KEYMAP[key], false);
                pressed = pressed.filter(k => k !== key);
                delete activeTouches[t.identifier];
            }
        }
    });
}

// Chamar depois que a ROM iniciar
const waitEmu = setInterval(() => {
    if (document.querySelector("#game")) {
        addEmuTouchListener();
        clearInterval(waitEmu);
    }
}, 100);

/* ===== FRAME ===== */
let framed=false;
btnFrame.onclick = () => {
    framed = !framed;
    
    btnFrame.src="Menu_Button_highlighted.png"; 
    setTimeout(() => {
        btnFrame.src="Menu_Button_normal.png";
    }, 100);

    if (framed) {
        game.style.top = "3px";
        game.style.left = "79px";
        game.style.width = "322px";
        game.style.height = "226px";

        frame.style.display = "block";
        tiles.style.display = "block";
        
        btnSpace.style.opacity = 1.0;
        dpad.style.opacity = 1.0;

        // START centralizado e mais baixo
        btnStart.style.left = "50%";
        btnStart.style.opacity = 1.0;
        btnStart.style.top = "78%";
        btnStart.style.transform = "translateX(-50%)";

    } else {
        game.style = "";
        frame.style.display = "none";
        tiles.style.display = "none";
        
        btnSpace.style.opacity = 0.5;
        dpad.style.opacity = 0.5;

        // START volta ao lugar original
        btnStart.style.left = "83%";
        btnStart.style.opacity = 0.5;
        btnStart.style.top = "18px";
        btnStart.style.transform = "translateX(-50%)";
    }
};

/* ===== OVERLAY ===== */
specialBtn.onclick=()=> {
    specialBtn.src="Menu_Button_Moon_highlighted.png";
    setTimeout(() => {
        overlay.style.display="block";
    }, 100);
};
overlay.onclick = e => {
    if (!e.target.closest("iframe")) {
        overlay.style.display = "none";
        specialBtn.src = "Menu_Button_Moon_normal.png";

        // Pausar todos os vídeos
        document.querySelectorAll(".video").forEach(v => {
            v.contentWindow.postMessage('{"event":"command","func":"pauseVideo","args":""}', '*');
        });
    }
};

/* ===== SPACE ===== */
let spacePressed = false;

btnSpace.ontouchstart = e => {
    e.preventDefault();
    if (spacePressed) return;
    spacePressed = true;
    sendKeyToEmulator(KEYMAP.Z, true);
    btnSpace.src = "A_Button_Pressed.png";
};

btnSpace.ontouchend = e => {
    e.preventDefault();
    spacePressed = false;
    sendKeyToEmulator(KEYMAP.Z, false);
    btnSpace.src = "A_Button_NotPressed.png";
};

btnSpace.ontouchcancel = btnSpace.ontouchend;

/* ===== D-PAD 8 DIREÇÕES POR ÂNGULO ===== */
const dpad=document.getElementById("dpad");
const center=57.5;
const dead=17;

function handleDpadTouch(e){
    e.preventDefault();
    const r = dpad.getBoundingClientRect();
    const t = e.touches[0];
    const x = t.clientX - r.left - center;
    const y = t.clientY - r.top - center;

    if(Math.abs(x)<dead && Math.abs(y)<dead){
        dpad.src="C2_DPad_NotPressed.png";
        return;
    }

    const a = Math.atan2(y, x)*180/Math.PI;

    // Zerar todas antes
    const keys = [];

    if(a>=-22.5 && a<22.5){
        keys.push("ArrowRight"); dpad.src="C2_DPad_R.png";
    }else if(a>=22.5 && a<67.5){
        keys.push("ArrowDown","ArrowRight"); dpad.src="C2_DPad_RD.png";
    }else if(a>=67.5 && a<112.5){
        keys.push("ArrowDown"); dpad.src="C2_DPad_D.png";
    }else if(a>=112.5 && a<157.5){
        keys.push("ArrowDown","ArrowLeft"); dpad.src="C2_DPad_LD.png";
    }else if(a>=157.5 || a<-157.5){
        keys.push("ArrowLeft"); dpad.src="C2_DPad_L.png";
    }else if(a>=-157.5 && a<-112.5){
        keys.push("ArrowUp","ArrowLeft"); dpad.src="C2_DPad_LU.png";
    }else if(a>=-112.5 && a<-67.5){
        keys.push("ArrowUp"); dpad.src="C2_DPad_U.png";
    }else if(a>=-67.5 && a<-22.5){
        keys.push("ArrowUp","ArrowRight"); dpad.src="C2_DPad_RU.png";
    }

    // Pressionar todas de uma vez mantendo o estado
    ["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].forEach(k=>{
        sendKeyToEmulator(KEYMAP[k], false);
        pressed = pressed.filter(p => p !== k);
    });
    keys.forEach(k => press(k));
}

dpad.ontouchstart = handleDpadTouch;
dpad.ontouchmove = handleDpadTouch;
dpad.ontouchend = () => {
    ["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].forEach(k=>{
        sendKeyToEmulator(KEYMAP[k], false);
    });
    dpad.src = "C2_DPad_NotPressed.png";
};
</script>

</body>
</html>